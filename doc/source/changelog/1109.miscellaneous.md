refactor and further cleanup for release