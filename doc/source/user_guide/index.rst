..
   This toctreemust be a top level index to get it to show up in
   pydata_sphinx_theme

.. toctree::
   :maxdepth: 1
   :hidden:

   prepocessor
   writer
   simulator
   postprocessor


========
Overview
========


Cardiac electromechanic simulation models the intricate processes that govern the heart's electrical activity and mechanical response, providing a comprehensive view of how the heart operates. This type of simulation is essential for understanding cardiac function, diagnosing conditions, and developing treatments.

Simulating these processes requires sophisticated computational tools and techniques. LS-DYNA is one such tool used in cardiac electromechanic simulation. It can run electrophysiology (EP) and mechanics simulations separately, as well as coupled electromechanics simulations. PyAnsys Heart leverages the potential of LS-DYNA to set up and drive these complex simulations effectively.

*PyAnsys Heart* is a high-level interface designed to use LS-DYNA for heart modeling. It provides convenient features to set up and drive cardiac simulations.



Brief theory
============
This section provides a brief review of key techniques in cardiac modeling. A list of references is also provided.

We assume that the reader has a basic knowledge of using LS-DYNA. However, you are encouraged to read the `LS-DYNA manuals`_ for a comprehensive understanding of the modeling process.



Anatomy generation
==================

Some anatomical details are difficult to capture with medical imaging techniques but are crucial for physical simulations. Fortunately, some rule-based methods proposed in the literature are included in this package.

- **Conduction System:**
The Purkinje network located on ventricular endocardium surfaces can be generated by a rule-based method published in `Costabal et al.`_. If atrial anatomy is included in the model, the left/right branch bundle, His bundle, and SA-AV path can be generated from specific landmarks.

- **Ventricular Fiber:**
Ventricular fibers can be generated using a rule-based method published in `Bayer et al.`_.

- **Atrial Fiber:**
Atrial fibers can be generated by a rule-based method published in `Piersanti et al.`_. Unlike ventricular fibers, which rely on the keyword ``*EM_EP_CREATEFIBERORIENTATION`` in LS-DYNA, this algorithm is implemented in the package by solving multiple (thermal) Laplace's equations in LS-DYNA.

- **UHC:**
A consistent Universal Heart Coordinates (UHC) system can be convenient for landmark determination, data transferring, etc. A universal ventricular coordinate system presented in `Bayer et al.2`_ is implemented. A universal coordinate system for atria, as presented in `Roney et al.`_, is to be implemented.



Electrophisology
================
- Mono/bi domain ?

- cell model ?

-?


Mechanics
=========

This section expalains the key elements in cardiac mechanical models and their default options in the package.


- Material:
Cardiac tissue is modeled using `MAT_295`_, which consists of two components: passive and active. By default, the passive component is represented by the `Holzapfel`-type model for both isotropic and anisotropic properties. For the active component, the `Guccione` model (ACTYPE=1) is used for mechanical models, while the `Hunter` model (ACTYPE=3) is employed for electromechanical models.

- Boundary conditions:
Boundary conditions are considered following the approach presented in `Strocchi et al.`_. Robin-type conditions are applied at the heart's valve regions, depending on the specific model constructed. Additionally, the pericardium's effect is accounted for by adding springs and dampers at the epicardium. For the ventricles, the stiffness of springs is scaled from different locations to constrain the motion primarily at the apex region.


- Circulation model
Many papers have described couplings between 3D heart models and 0D circulation models, such as those by `Agustin et al.`_. LS-DYNA uses ``CONTROL_VOLUME`` related keywords to achieve this feature. By default, the package provides a simple open-loop model. Specifically, a 2-element Windkessel model is applied to the left or right ventricle. If the atrium is present, atrioventricular valves are represented by a diode model, and a constant inflow is set for both atria. If no atrium is present, a constant pressure (preload) is set.

Figure(?)
closed loop, twin builder ?

- Stress free configuration

We assume that the input geometry is in the state of end-diastole. To account for the initial stress from the end-diastolic pressure, we first compute the stress-free configuration using the keyword `*CONTROL_REFERENCE_CONFIGURATION`. Then, the pressure is reapplied to the stress-free geometry, and we export a "virtual" end-diastolic mesh with the initial stress. This mesh is subsequently used in the contraction simulation.



References
==========
.. _LS-DYNA manuals:
LS-DYNA manuals: https://lsdyna.ansys.com/manuals/

.. _MAT_295:
MAT_295: https://ftp.lstc.com/anonymous/outgoing/support/PAPERS/mat_295_formulation_public.pdf

.. _Bayer et al.:
Bayer, J.D., Blake, R. C., Plank, G., and Trayanova, N. A., “A novel rule-based algorithm for assigning myocardial fiber orientation to computational heart models,” Annals of biomedical engineering,
40(10), 2243-2254 (2012)

.. _Costabal et al.:
Costabal, Francisco Sahli, Daniel E. Hurtado, and Ellen Kuhl. "Generating Purkinje networks in the human heart." Journal of biomechanics 49.12 (2016): 2455-2465.

.. _Strocchi et al.:
Strocchi, Marina, et al. "Simulating ventricular systolic motion in a four-chamber heart model with spatially varying robin boundary conditions to model the effect of the pericardium." Journal of Biomechanics 101 (2020): 109645.

.. _Piersanti et al.:
Piersanti, Roberto, et al. "Modeling cardiac muscle fibers in ventricular and atrial electrophysiology simulations." Computer Methods in Applied Mechanics and Engineering 373 (2021): 113468.

.. TODO: atrial coordinate system

.. _Roney et al.:
Roney, Caroline H., et al. "Universal atrial coordinates applied to visualisation, registration and construction of patient specific meshes." Medical image analysis 55 (2019): 65-75.

.. _Bayer et al.2:
Bayer, Jason, et al. "Universal ventricular coordinates: A generic framework for describing position within the heart and transferring data." Medical image analysis 45 (2018): 83-93.

.. numerical damping from here:

.. _Agustin et al.:
Augustin, Christoph M., et al. "A computationally efficient physiologically comprehensive 3D-0D closed-loop model of the heart and circulation." Computer methods in applied mechanics and engineering 386 (2021): 114092.