cleanup and refactor preprocessor module