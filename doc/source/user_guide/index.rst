..
   This toctreemust be a top level index to get it to show up in
   pydata_sphinx_theme

.. toctree::
   :maxdepth: 1
   :hidden:

   prepocessor
   writer
   simulator
   postprocessor


========
Overview
========


Cardiac electromechanic simulation models the intricate processes that governs the heart's electrical activity and mechanical response, providing a comprehensive view of how the heart operates. This type of simulation is essential for understanding cardiac function, diagnosing conditions, and developing treatments.

Simulating these processes requires sophisticated computational tools and techniques. LS-DYNA is one such tool used in cardiac electromechanic simulation. It can run electrophysiology (EP) and mechanics simulations separately, as well as coupled electromechanics simulations. PyAnsys Heart leverages the potential of LS-DYNA to set up and drive these complex simulations effectively.

*PyAnsys Heart* is a high-level interface designed to use LS-DYNA for heart modeling. It provides convenient features to set up and drive cardiac simulations.



Brief theory
============
This section provides a brief review of key techniques in cardiac modeling. A list of references is also provided.

It is assumed that the reader has a basic knowledge on LS-DYNA usage. However, it is encouraged to read the `LS-DYNA manuals`_ for a comprehensive understanding of the modeling process.



Anatomy generation
==================

Some anatomical details are difficult to capture with medical imaging techniques but are crucial for physical simulations. Fortunately, some rule-based methods proposed in the literature are included in this package.

- **Conduction System:**
   The Purkinje network located on ventricular endocardium surfaces can be generated by a rule-based method published in `Costabal et al.`_. If atrial anatomy is included in the model, the left/right branch bundle, His bundle, and SA AV path can be generated from specific landmarks.

- **Ventricular Fiber:**
   Ventricular fibers can be generated using a rule-based method published in `Bayer et al.`_.

- **Atrial Fiber:**
   Atrial fibers can be generated by a rule-based method published in `Piersanti et al.`_. Unlike ventricular fibers, which rely on the keyword ``*EM_EP_CREATEFIBERORIENTATION`` in LS-DYNA, this algorithm is implemented in the package by solving multiple (thermal) Laplace's equations in LS-DYNA.

- **UHC:**
   A consistent Universal Heart Coordinates (UHC) system can be convenient for landmark determination, data transferring, etc. A universal ventricular coordinate system presented in `Bayer et al.2`_ is implemented. A universal coordinate system for atria, as presented in `Roney et al.`_, is to be implemented.



Electrophysiology
=================

This section introduces cardiac electrophysiology modeling in *PyAnsys Heart*.
Three options are available to model electrical propagation in *PyAnsys Heart* (see `simulator.settings.settings.EPAnalysis.solvertype`): `Monodomain` (``*EM_CONTROL`` with EMSOL=11 in LS-DYNA), `Eikonal` (``*EM_CONTROL`` with EMSOL=14 in LS-DYNA) and `ReactionEikonal` model (``*EM_CONTROL`` with EMSOL=15 in LS-DYNA).

- Monodomain:
   The Monodomain model is a reaction-diffusion model and is a simplification of the Bidomain model `Potse et al.`_. In LS-DYNA, the 'passive' electrical material properties (electrical conductivity, membrane capacitance, surface/volume ratio) corresponding to the Monodomain model are set in ``*EM_MAT_003`` for the myocardium and ``*EM_MAT_001`` for the beams of the conduction system. These are to be completed with 'active' properties using a cell model (see 'cell model' section).
   Note: LS-DYNA offers the possibility of using either the Bidomain, Monodomain, or a mix of both models but only the Monodomain is exposed in *PyAnsys Heart* for now.

- Eikonal:
   In this case only the activation time is computed, no cell model is used.
   Here, the 'passive' electrical material properties are also set with ``*EM_MAT_003`` for 3D tissue and ``*EM_MAT_001`` for the beams of the conduction system.

- Reaction Eikonal:
   The Reaction Eikonal model first computes the activation time on each node, then it assigns action potential curves to each node with a time delay that corresponds to the activation time. Passive properties are the same as those describes in the pure Eikonal model.

- cell model:
   The cell model used in the package is the `TenTusscher et al.`_ model, other models are to be added in the future.
   When UHCs are computed, the transmural coordinate is used to distinguish between endo-, epi- and mid- myocardium layers using the corresponding version of the TenTusscher model.
   Note: LS-DYNA supports other cell models and user defined models, see the `*EM_EP` collection of keywords in `LS-DYNA manuals`_.

- Stimulation:
   Tissue stimulation is set by default on the SA node in a four-chamber model and in the left (and right) apex in case of a left (biventricular) model. However, users can define their own stimulation origin and profile (see the `Stimulation definition example`).


Mechanics
=========

This section explains the key elements in cardiac mechanical models and their default options in the package.


- Material:
   Cardiac tissue mechanics is modeled using `MAT_295`_, which consists of two components: passive and active. By default, the passive component is represented by the `Holzapfel`-type model for both isotropic and anisotropic properties. For the active component, the `Guccione` model (ACTYPE=1) is used for mechanical models, while the `Hunter` model (ACTYPE=3) is employed for electromechanical models.

- Boundary conditions:
   Boundary conditions are considered following the approach presented in `Strocchi et al.`_. Robin-type conditions are applied at the heart's valve regions, depending on the specific model constructed. Additionally, the pericardium's effect is accounted for by adding springs and dampers at the epicardium. For the ventricles, the stiffness of springs is scaled from different locations to constrain the motion primarily at the apex region.


- Circulation model
   Many papers have described couplings between 3D heart models and 0D circulation models, such as those by `Agustin et al.`_. LS-DYNA uses ``CONTROL_VOLUME`` related keywords to achieve this feature. By default, the package provides a simple open-loop model. Specifically, a 2-element Windkessel model is applied to the left or right ventricle. If the atrium is present, atrioventricular valves are represented by a diode model, and a constant inflow is set for both atria. If no atrium is present, a constant pressure (preload) is set.

.. Figure(?)
.. closed loop, twin builder ?

- Stress free configuration
   It is assumed that the input geometry is in the state of end-diastole. To account for the initial stress from the end-diastolic pressure, the stress-free configuration is computed using the keyword `*CONTROL_REFERENCE_CONFIGURATION`. Then, the pressure is reapplied to the stress-free geometry, and a "virtual" end-diastolic mesh with the initial stress is exported. This mesh is subsequently used in the contraction simulation.



References
==========

_`LS-DYNA manuals`: https://lsdyna.ansys.com/manuals/

_`MAT_295`: https://ftp.lstc.com/anonymous/outgoing/support/PAPERS/mat_295_formulation_public.pdf

_`Bayer et al.`: Bayer, J.D., Blake, R. C., Plank, G., and Trayanova, N. A., “A novel rule-based algorithm for assigning myocardial fiber orientation to computational heart models,” Annals of biomedical engineering, 40(10), 2243-2254 (2012)

_`Costabal et al.`: Costabal, Francisco Sahli, Daniel E. Hurtado, and Ellen Kuhl. "Generating Purkinje networks in the human heart." Journal of biomechanics 49.12 (2016): 2455-2465.

_`Strocchi et al.`: Strocchi, Marina, et al. "Simulating ventricular systolic motion in a four-chamber heart model with spatially varying robin boundary conditions to model the effect of the pericardium." Journal of Biomechanics 101 (2020): 109645.

_`Piersanti et al.`: Piersanti, Roberto, et al. "Modeling cardiac muscle fibers in ventricular and atrial electrophysiology simulations." Computer Methods in Applied Mechanics and Engineering 373 (2021): 113468.

_`Roney et al.`: Roney, Caroline H., et al. “Universal atrial coordinates applied to visualisation, registration and construction of patient specific meshes.” Medical image analysis 55 (2019): 65-75.

_`Bayer et al.2`: Bayer, Jason, et al. “Universal ventricular coordinates: A generic framework for describing position within the heart and transferring data.” Medical image analysis 45 (2018): 83-93.

_`Agustin et al.`: Augustin, Christoph M., et al. “A computationally efficient physiologically comprehensive 3D-0D closed-loop model of the heart and circulation.” Computer methods in applied mechanics and engineering 386 (2021): 114092.

_`Potse et al.`: Potse, M., Dube, B., Richer, J., Vinet, A., Gulrajani, R.: A comparison of monodomain and bidomain reaction-diffusion models for action potential propagation in the human heart. IEEE Transactions on Biomedical Engineering 53(12), 2425- 2435 (dec 2006).

_`TenTusscher et al.`: Ten Tusscher, K. H., & Panfilov, A. V. (2006). Alternans and spiral breakup in a human ventricular tissue model. American Journal of Physiology-Heart and Circulatory Physiology, 291(3), H1088-H1100.



.. numerical damping from here

.. TODO: atrial coordinate system