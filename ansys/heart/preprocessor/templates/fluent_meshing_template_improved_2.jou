; fluent meshing journal 
; 
; set some settings for meshing 
(define files-to-import '() )
(define min-size {{mesh_size}} )    ; mesh size in mm 
(define max-size {{mesh_size}} )     
(define growth-rate-wrap 1.2 )     ; growth rate default 1.2
;( define my-output-mesh "fluent_volumemesh.msh.h5" )
( define my-output-mesh "{{output_path}}" )
; import files
/file/import/cad no "{{work_directory}}" "part_*.stl" yes 40 yes mm
; start logging
/file/start-transcript "fluent_meshing.log" ok
; rename boundary
/objects/merge '(*) "heart"
/objects/labels/create-label-per-zone "heart" '(*)
; merge duplicate nodes
/diagnostics/face-connectivity/fix-free-faces objects '(*) merge-nodes yes 1e-3
; create intersection loops
/objects/create-intersection-loops collectively '(*)
; add feature edges 
;/boundary/feature/create-edge-zones '(*) adaptive-angle yes 
; extracts sharp features
/boundary/feature/create-edge-zones '(*) fixed-angle 70 yes
; set size field (just global size for now)
( ti-menu-load-string 				
	( format #f 
		"/size-functions/set-global-controls ~a ~a ~a" min-size max-size growth-rate-wrap
	)  
)
/scoped-sizing/compute yes 
; wrap objects 
/objects/wrap/wrap '(*) collectively "wrapped-myocardium" shrink-wrap external "wrap" hybrid 0.8 yes
;
{{blood_pool_script}}
;
; compute volumetric regions 
/objects/volumetric-regions compute "wrapped-myocardium" no
/objects/volumetric-regions/change-type "wrapped-myocardium" '(*) solid
; start automeshing
/mesh/tet/controls/cell-sizing size-field
/mesh/auto-mesh "wrapped-myocardium" yes pyramids tet no
; improve quality
/mesh/modify/auto-node-move '(*) '(*) 0.3 50 120 yes 5
; clean up 
/objects/delete-all-geom
/mesh/zone-names-clean-up yes
/mesh/prepare-for-solve yes
/mesh/check-mesh
/mesh/check-quality
; write to file 
( ti-menu-load-string 				
	(format #f "/file/write-mesh ~a ok" my-output-mesh )
)
;/exit yes
